{%extends "base.html"%}

{%block head%}
<script type="text/javascript" src="/_/paper.js"></script>
<script type="text/paperscript" canvas="myCanvas">
var balls = [];
var group = new Group();

var Ball = Base.extend({
    initialize: function(point, vector, name) {
        if (!vector || vector.isZero()) {
            this.vector = Point.random() * 5;
        } else {
            this.vector = vector * 2;
        }
        this.name = name;
        this.point = point;
        this.dampen = 0.4;
        this.gravity = 3;
        this.bounce = -0.6;
        this.radius = 50 * Math.random() + 30;
        this.createPaths();
        group.addChild(this.item);
    },

    createPaths: function() {
        var overlayPos = this.point + this.radius / 8;
        var compound = new CompoundPath([
            new Path.Circle(this.point, this.radius),
            new Path.Circle(overlayPos, this.radius / 2)
        ]);
        var color = new HSBColor(Math.random() * 360, 1, 1);
        var gradient = new Gradient([color, 'black'], 'radial');
        compound.children[0].fillColor = new GradientColor(gradient, this.point,
                this.point + this.radius, overlayPos);
        var overlay = new Path.Circle(overlayPos, this.radius / 2);
        var overlayColor = color.clone();
        var fullOverlay = color.clone();
        overlayColor.alpha = 0.5;
        var overlayGradient = new Gradient([new RGBColor(1, 1, 1, 0.5), new RGBColor(1, 1, 1, 1)]);
        overlay.fillColor = new GradientColor(overlayGradient, overlayPos, overlayPos + this.radius / 2);
        
        var nameItem = new PointText(0, 0);
        nameItem.fillColor = 'black';
        nameItem.content = this.name;
        
        this.item = new Group([compound, overlay, nameItem]);
    },

    iterate: function() {
        var size = view.size;
        this.vector.y += this.gravity;
        this.vector.x *= 0.90;
        var pre = this.point + this.vector;
        if (pre.x < this.radius || pre.x > size.width - this.radius)
            this.vector.x *= -this.dampen; 
        if (pre.y < this.radius || pre.y > size.height - this.radius) {
            if (Math.abs(this.vector.x) < 3)
                this.vector = Point.random() * [150, 100] + [-75, 20];
            this.vector.y *= this.bounce;
        }

        var max = Point.max(this.radius, this.point + this.vector);
        this.item.position = this.point = Point.min(max, size - this.radius);
        this.item.rotate(this.vector.x / 2);
    }
});

var attendees = {{ attendees }};

for (var i = 0; i < attendees.length; i++) {
    var position = Point.random() * view.size,
        vector = (Point.random() - [0.5, 0]) * [50, 100],
        ball = new Ball(position, vector, attendees[0]);
    balls.push(ball);
}

/*var textItem = new PointText(20, 30);
textItem.fillColor = 'black';
textItem.content = 'Click, drag and release to add balls.'*/

var lastDelta;
function onMouseDrag(event) {
    lastDelta = event.delta;
}

function onMouseUp(event) {
    var ball = new Ball(event.point, lastDelta);
    balls.push(ball);
    lastDelta = null;
}

function onFrame() {
    for (var i = 0, l = balls.length; i < l; i++)
        balls[i].iterate();
}
</script>
{%endblock%}

{%block body%}
<h2>Meeting {{meeting.name}}</h2>
<h3>{{meeting.date}}</h3>
<p>{{meeting.description}}</p>

<ul>
{%for attendee in meeting.attendees%}
<li>
	<a href="{%url views.alert meeting.key.id%}" class="hijax">{{attendee}}</a>
</li>
{%endfor%}
</ul>

<a href="{%url views.alert meeting.key.id%}" class="hijax">Send alert</a>

<canvas id="myCanvas" resize="true"></canvas>

{%endblock%}